import{j as e}from"./ui-CYJXyMFH.js";import{r as t}from"./vendor-BtPQM8GQ.js";import{B as s}from"./index-B3OkbNa5.js";import{u as n}from"./query-CekFPK04.js";import{c as a}from"./router-BKNbbwl4.js";import{X as r,a as i,b as o,V as l,c,d as u,e as d,S as m,U as g,E as h,M as b}from"./icons-Dm8dLJzq.js";import"./three-Bx_9lKOs.js";const p=({language:p="auto"})=>{const[x,f]=t.useState(!1),[v,w]=t.useState(!1),[y,j]=t.useState({x:24,y:24}),[S,k]=t.useState(!1),[N,E]=t.useState({x:0,y:0,initialX:0,initialY:0}),[I,L]=t.useState(!1),M=a(),{status:C,sendMessage:T,messages:_}=(()=>{const[e,s]=t.useState([]),[a,r]=t.useState("idle"),[i,o]=t.useState(null);t.useEffect(()=>{const e=localStorage.getItem("ai_session_id"),t=localStorage.getItem("ai_messages");if(e&&o(e),t)try{const e=JSON.parse(t).map(e=>({...e,timestamp:new Date(e.timestamp)}));s(e)}catch(n){}},[]),t.useEffect(()=>{e.length>0&&localStorage.setItem("ai_messages",JSON.stringify(e))},[e]),t.useEffect(()=>{i&&localStorage.setItem("ai_session_id",i)},[i]);const l=n({mutationFn:async e=>{try{const t=await fetch("http://localhost:5000/api/talk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`API Error: ${t.status} ${t.statusText}`);return await t.json()}catch(t){await new Promise(e=>setTimeout(e,1e3+1e3*Math.random()));const s={th:["สวัสดีครับ! ยินดีต้อนรับสู่ PaiNaiDee ครับ","ขอบคุณที่ใช้บริการของเราครับ มีอะไรให้ช่วยเหลือไหมครับ?","ผมพร้อมช่วยแนะนำสถานที่ท่องเที่ยวในประเทศไทยให้ครับ","หากต้องการข้อมูลเกี่ยวกับการท่องเที่ยว กรุณาสอบถามได้เลยครับ"],en:["Hello! Welcome to PaiNaiDee, your travel companion!","Thank you for using our service. How can I help you today?","I'm ready to recommend amazing places to visit in Thailand","Feel free to ask me anything about travel destinations!"]},n=/[\u0E00-\u0E7F]/.test(e.message),a="auto"===e.language?n?"th":"en":e.language||"en",r=s[a]||s.en;return{response:r[Math.floor(Math.random()*r.length)],session_id:i||`session_${Date.now()}`,language:a,confidence:.85+.15*Math.random(),intent:"greeting"}}},onMutate:()=>{r("thinking")},onSuccess:e=>{e.session_id&&e.session_id!==i&&o(e.session_id);const t={id:Date.now().toString(),text:e.response,sender:"ai",timestamp:new Date,language:e.language};if(s(e=>[...e,t]),r("talking"),"speechSynthesis"in window){const t=new SpeechSynthesisUtterance(e.response);t.lang="th"===e.language?"th-TH":"en-US",t.rate=.9,t.pitch=1,t.onend=()=>{r("idle")},speechSynthesis.speak(t)}else{const t=Math.max(2e3,50*e.response.length);setTimeout(()=>{r("idle")},t)}},onError:e=>{r("error"),setTimeout(()=>r("idle"),3e3)}}),c=t.useCallback((e,t="auto")=>{if(!e.trim())return;const n={id:Date.now().toString(),text:e.trim(),sender:"user",timestamp:new Date,language:t};s(e=>[...e,n]),l.mutate({message:e.trim(),session_id:i||void 0,language:t})},[l,i]),u=t.useCallback(()=>{s([]),r("idle"),o(null),localStorage.removeItem("ai_session_id"),localStorage.removeItem("ai_messages")},[]),d=t.useCallback(()=>{r("listening")},[]),m=t.useCallback(()=>{r("idle")},[]);return{messages:e,status:a,sessionId:i,isLoading:l.isPending,error:l.error,sendMessage:c,clearMessages:u,startListening:d,stopListening:m}})(),{isListening:A,isSupported:H,startListening:q,stopListening:D}=((e={})=>{const[s,n]=t.useState(!1),[a,r]=t.useState(""),[i,o]=t.useState(null),[l,c]=t.useState(!1),u=t.useRef(null),d=t.useRef(null);t.useEffect(()=>{const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(c(!!t),t){u.current=new t;const s=u.current;s.continuous=e.continuous??!1,s.interimResults=e.interimResults??!0,s.lang=e.language??"th-TH",s.onresult=e=>{var t,s,n;let a="",i="";for(let r=e.resultIndex;r<e.results.length;r++){const t=e.results[r],s=t[0].transcript;t.isFinal?a+=s:i+=s}const o=a||i;r(o),d.current&&d.current({transcript:o,confidence:(null==(s=null==(t=e.results[e.results.length-1])?void 0:t[0])?void 0:s.confidence)??0,isFinal:(null==(n=e.results[e.results.length-1])?void 0:n.isFinal)??!1})},s.onerror=e=>{o(e.error),n(!1)},s.onend=()=>{n(!1)},s.onstart=()=>{n(!0),o(null)}}return()=>{u.current&&u.current.abort()}},[e.continuous,e.interimResults,e.language]);const m=t.useCallback(e=>{if(l){if(u.current&&!s){d.current=e||null,r(""),o(null);try{u.current.start()}catch{o("Failed to start speech recognition")}}}else o("Speech recognition is not supported in this browser")},[l,s]),g=t.useCallback(()=>{u.current&&s&&u.current.stop()},[s]),h=t.useCallback(()=>{u.current&&(u.current.abort(),n(!1))},[]),b=t.useCallback(e=>{u.current&&(u.current.lang=e)},[]);return{isListening:s,transcript:a,error:i,isSupported:l,startListening:m,stopListening:g,abortListening:h,changeLanguage:b}})({language:"th"===p?"th-TH":"en-US",continuous:!1,interimResults:!0});t.useEffect(()=>{f(!1)},[M.pathname]),t.useEffect(()=>{"true"===localStorage.getItem("aiAssistantHidden")&&L(!0)},[]);const F={th:[{id:"nearby",icon:u,label:"หาที่ใกล้ฉัน",query:"หาสถานที่ท่องเที่ยวใกล้ฉัน",color:"bg-green-100 hover:bg-green-200 text-green-700"},{id:"map",icon:d,label:"แผนที่ท่องเที่ยว",query:"แสดงแผนที่สถานที่ท่องเที่ยวในประเทศไทย",color:"bg-blue-100 hover:bg-blue-200 text-blue-700"},{id:"top-attractions",icon:m,label:"สถานที่ยอดนิยม",query:"แนะนำสถานที่ท่องเที่ยวยอดนิยมในประเทศไทย",color:"bg-yellow-100 hover:bg-yellow-200 text-yellow-700"},{id:"food",icon:g,label:"อาหารท้องถิ่น",query:"แนะนำอาหารท้องถิ่นและร้านอาหารดีๆ",color:"bg-orange-100 hover:bg-orange-200 text-orange-700"}],en:[{id:"nearby",icon:u,label:"Find nearby",query:"Find tourist attractions near my location",color:"bg-green-100 hover:bg-green-200 text-green-700"},{id:"map",icon:d,label:"Travel map",query:"Show me a travel map of Thailand",color:"bg-blue-100 hover:bg-blue-200 text-blue-700"},{id:"top-attractions",icon:m,label:"Top attractions",query:"Recommend top tourist attractions in Thailand",color:"bg-yellow-100 hover:bg-yellow-200 text-yellow-700"},{id:"food",icon:g,label:"Local food",query:"Recommend local Thai food and restaurants",color:"bg-orange-100 hover:bg-orange-200 text-orange-700"}]},R="th"===p?F.th:F.en,z=e=>{if("hide"===e)return L(!0),localStorage.setItem("aiAssistantHidden","true"),void f(!1);T(e,p),f(!1)},X=()=>{L(!1),localStorage.removeItem("aiAssistantHidden")},Y=e=>{switch(e){case"idle":return"bg-blue-500";case"listening":return"bg-green-500 animate-pulse";case"thinking":return"bg-yellow-500 animate-pulse";case"talking":return"bg-purple-500 animate-pulse";case"error":return"bg-red-500";default:return"bg-gray-500"}},P=e=>{if(!S)return;const t=e.clientX-N.x,s=e.clientY-N.y,n=Math.max(16,Math.min(window.innerWidth-80,N.initialX-t)),a=Math.max(16,Math.min(window.innerHeight-80,N.initialY-s));j({x:n,y:a})},$=()=>{k(!1)};t.useEffect(()=>{if(S)return document.addEventListener("mousemove",P),document.addEventListener("mouseup",$),()=>{document.removeEventListener("mousemove",P),document.removeEventListener("mouseup",$)}},[S,N]);const O=e=>{if(!S||0===e.touches.length)return;e.preventDefault();const t=e.touches[0],s=t.clientX-N.x,n=t.clientY-N.y,a=Math.max(16,Math.min(window.innerWidth-80,N.initialX-s)),r=Math.max(16,Math.min(window.innerHeight-80,N.initialY-n));j({x:a,y:r})},U=()=>{k(!1)};return t.useEffect(()=>{if(S)return document.addEventListener("touchmove",O,{passive:!1}),document.addEventListener("touchend",U),()=>{document.removeEventListener("touchmove",O),document.removeEventListener("touchend",U)}},[S,N]),"/ai-assistant"===M.pathname?null:I?e.jsx("div",{className:"fixed bottom-4 left-4 z-50",children:e.jsx(s,{onClick:X,size:"sm",variant:"outline",className:"bg-background/90 backdrop-blur-sm border-border/50 hover:bg-accent/50 text-xs shadow-lg",children:"th"===p?"แสดง AI":"Show AI"})}):e.jsxs("div",{className:"fixed z-50 transition-all duration-300",style:{bottom:`${y.y}px`,right:`${y.x}px`,cursor:S?"grabbing":"grab"},children:[x&&e.jsxs("div",{className:"absolute bottom-20 right-0 w-72 bg-background/95 backdrop-blur-sm rounded-2xl shadow-2xl border border-border p-4 animate-scale-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"th"===p?"ผู้ช่วย AI":"AI Assistant"}),e.jsx(s,{variant:"ghost",size:"sm",onClick:()=>f(!1),className:"w-8 h-8 p-0",children:e.jsx(r,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs(s,{variant:A?"default":"outline",size:"sm",onClick:()=>{A?D():q(e=>{e.isFinal&&e.transcript.trim()&&(T(e.transcript,p),f(!1))})},disabled:!H,className:"flex-1",children:[A?e.jsx(i,{className:"h-4 w-4 mr-2"}):e.jsx(o,{className:"h-4 w-4 mr-2"}),"th"===p?A?"หยุดฟัง":"เริ่มพูด":A?"Stop":"Speak"]}),e.jsx(s,{variant:"ghost",size:"sm",onClick:()=>w(!v),className:"w-10 h-10 p-0",children:v?e.jsx(l,{className:"h-4 w-4"}):e.jsx(c,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:R.map(t=>{const n=t.icon;return e.jsxs(s,{variant:"outline",onClick:()=>z(t.query),className:`h-auto p-3 flex flex-col items-center space-y-2 border-0 ${t.color}`,children:[e.jsx(n,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs font-medium text-center leading-tight",children:t.label})]},t.id)})}),e.jsx("div",{className:"mt-3 pt-3 border-t border-border",children:e.jsxs(s,{variant:"ghost",size:"sm",onClick:()=>z("hide"),className:"w-full justify-start text-muted-foreground hover:text-foreground",children:[e.jsx(h,{className:"h-4 w-4 mr-2"}),"th"===p?"ซ่อนผู้ช่วย":"Hide Assistant"]})}),"idle"!==C&&e.jsx("div",{className:"mt-4 p-2 bg-muted rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${Y(C)}`}),e.jsx("span",{className:"text-sm text-muted-foreground capitalize",children:"th"===p?"listening"===C?"กำลังฟัง...":"thinking"===C?"กำลังคิด...":"talking"===C?"กำลังตอบ...":C:C})]})})]}),e.jsxs("div",{className:"w-16 h-16 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-full shadow-lg border border-primary/30 backdrop-blur-sm cursor-pointer hover:scale-110 transition-all duration-200 relative",onClick:()=>f(!x),onMouseDown:e=>{0===e.button&&(e.stopPropagation(),k(!0),E({x:e.clientX,y:e.clientY,initialX:y.x,initialY:y.y}))},onTouchStart:e=>{e.stopPropagation();const t=e.touches[0];k(!0),E({x:t.clientX,y:t.clientY,initialX:y.x,initialY:y.y})},children:[e.jsxs("div",{className:"w-full h-full flex items-center justify-center relative",children:[e.jsx("div",{className:"w-12 h-12 rounded-full transition-all duration-300 flex items-center justify-center "+("listening"===C?"bg-green-400 animate-pulse":"thinking"===C?"bg-yellow-400":"talking"===C?"bg-blue-400 animate-bounce":"bg-primary"),children:e.jsx("div",{className:"text-white text-xl",children:(e=>{switch(e){case"listening":return"👂";case"thinking":return"🤔";case"talking":return"🗣️";case"error":return"❌";default:return"🤖"}})(C)})}),e.jsx("div",{className:`absolute -top-1 -right-1 w-4 h-4 rounded-full border-2 border-background ${Y(C)}`}),_.length>0&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-primary text-primary-foreground text-xs w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold",children:_.length>9?"9+":_.length}),!x&&e.jsx("div",{className:"absolute -bottom-1 -left-1 bg-background border border-border rounded-full p-1",children:e.jsx(b,{className:"h-3 w-3 text-primary"})})]}),!x&&"idle"===C&&0===_.length&&e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-background/90 backdrop-blur-sm text-foreground px-3 py-1 rounded-lg text-xs shadow-lg border animate-fade-in whitespace-nowrap",children:["th"===p?"คลิกเพื่อสอบถาม AI":"Click to ask AI",e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-background/90"})]})]})]})};export{p as default};
